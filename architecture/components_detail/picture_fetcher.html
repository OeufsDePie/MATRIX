

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3.3.1. Picture Fetcher &mdash; MATRIX 0.1 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="MATRIX 0.1 documentation" href="../../index.html"/>
        <link rel="up" title="3.3. Components implementation" href="../components_detail.html"/>
        <link rel="next" title="3.3.2. Picture Manager" href="picture_manager.html"/>
        <link rel="prev" title="3.3. Components implementation" href="../components_detail.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> MATRIX</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../context.html">1. Context and Objectives</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../context.html#on-set-special-effects">1.1. On-set special effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../context.html#current-solution">1.2. Current solution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../context.html#objectives-of-the-application">1.3. Objectives of the application</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../user.html">2. Use of the Application</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../user/workspaces.html">2.1. Managing workspaces and scenes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user/photos.html">2.2. Managing the photo selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user/camera.html">2.3. Camera connection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user/3d.html">2.4. 3D Reconstruction and Rendering</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user/map.html">2.5. Map localization</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../../architecture.html">3. Architecture of the Application</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../components_global.html">3.1. Global architecture of the application</a></li>
<li class="toctree-l2"><a class="reference internal" href="../model_view.html">3.2. The model / view pattern</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../components_detail.html">3.3. Components implementation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../code.html">4. Code Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../code/modules.html">4.1. MatrixGUI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../code/Python/modules.html">4.2. Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../code/PyQt/modules.html">4.3. PyQt</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../doc.html">5. Building that Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../doc.html#sphinx-installation">5.1. Sphinx Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../doc.html#initialize-the-documentation">5.2. Initialize the documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../doc.html#configuration-of-sphinx-documentation">5.3. Configuration of Sphinx documentation</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">MATRIX</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../architecture.html">3. Architecture of the Application</a> &raquo;</li>
      
          <li><a href="../components_detail.html">3.3. Components implementation</a> &raquo;</li>
      
    <li>3.3.1. Picture Fetcher</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../../_sources/architecture/components_detail/picture_fetcher.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="picture-fetcher">
<h1><a class="toc-backref" href="#id1">3.3.1. Picture Fetcher</a><a class="headerlink" href="#picture-fetcher" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#picture-fetcher" id="id1">Picture Fetcher</a><ul>
<li><a class="reference internal" href="#interface-with-the-gphoto2-command-line-interface" id="id2">Interface with the <code class="docutils literal"><span class="pre">gphoto2</span></code> command-line interface</a></li>
<li><a class="reference internal" href="#active-watching-of-the-camera" id="id3">Active watching of the camera</a></li>
<li><a class="reference internal" href="#camera-locking" id="id4">Camera locking</a></li>
</ul>
</li>
</ul>
</div>
<p>This module is made of a single class <code class="docutils literal"><span class="pre">Pygphoto</span></code> defined in the file
<a class="reference external" href="http://example.com/">pygphoto.py</a>. It allows to interact with a USB camera using the
<a class="reference external" href="http://www.gphoto.org/">gphoto2</a> tool. Common actions include : listing the names of the
photos present in the camera, watching for new files, downloading
photos individually etc.</p>
<div class="section" id="interface-with-the-gphoto2-command-line-interface">
<h2><a class="toc-backref" href="#id2">3.3.1.1. Interface with the <code class="docutils literal"><span class="pre">gphoto2</span></code> command-line interface</a><a class="headerlink" href="#interface-with-the-gphoto2-command-line-interface" title="Permalink to this headline">¶</a></h2>
<p>The module uses directly the <a class="reference external" href="http://www.gphoto.org/doc/manual/ref-gphoto2-cli.html">gphoto2 command-line interface</a> for
prototyping. It would be wiser to create a <cite>C</cite> module that uses the
<code class="docutils literal"><span class="pre">C</span></code> API of gphoto2 called <a class="reference external" href="http://gphoto.sourceforge.net/doc/api/index.html">libgphoto2</a> and offer a interface for all
the needed operations. This <cite>C</cite> module would be compiled as a shared
library and imported in Python with <a class="reference external" href="http://docs.python.org/3/library/ctypes.html">ctypes</a>.</p>
<p>However, the current implementation makes extended use of the
command-line interface provided by <code class="docutils literal"><span class="pre">gphoto2</span></code>, through hardcoded calls
and output parsing.</p>
<p>The calls to gphoto2 are made with the <a class="reference external" href="http://docs.python.org/3.4/library/subprocess.html">subprocess</a> Python module.</p>
<p>Simple calls are done like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;gphoto2&quot;</span><span class="p">,</span> <span class="s">&quot;--get-all-files&quot;</span><span class="p">]</span>
<span class="n">return_code</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</pre></div>
</div>
<p>When the output need to be parsed, it is necessary to use the blocking
<code class="docutils literal"><span class="pre">subprocess.check_output()</span></code> function and to decode the binary stream
as an UTF-8 string:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;gphoto2&quot;</span><span class="p">,</span> <span class="s">&quot;--summary&quot;</span><span class="p">]</span>
<span class="n">output_string</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">command</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="active-watching-of-the-camera">
<h2><a class="toc-backref" href="#id3">3.3.1.2. Active watching of the camera</a><a class="headerlink" href="#active-watching-of-the-camera" title="Permalink to this headline">¶</a></h2>
<p>When instantiated, the <code class="docutils literal"><span class="pre">Pygphoto</span></code> class create a daemon thread that
actively watch for new camera connections/disconnections and pictures
creation/deletion. The two associated signals <code class="docutils literal"><span class="pre">onCameraConnection</span></code> and
<code class="docutils literal"><span class="pre">onContentChanged</span></code> are the only signals emitted by <code class="docutils literal"><span class="pre">Pygphoto</span></code>.</p>
<p>The <code class="docutils literal"><span class="pre">CameraWatcher</span></code> internal class is responsible for the active
watching. The threading is made by moving the instance of
<code class="docutils literal"><span class="pre">CameraWatcher</span></code> to a <code class="docutils literal"><span class="pre">QThread</span></code> at initialisation. Using <code class="docutils literal"><span class="pre">QThread</span></code>
allows for easy asynchronous communication with the <code class="docutils literal"><span class="pre">CameraWatcher</span></code>&#8216;s
thread through the use of <cite>Qt</cite>&#8216;s signals.</p>
<p><strong>Note</strong>: As the <code class="docutils literal"><span class="pre">CameraWatcher</span></code> class is internal, <code class="docutils literal"><span class="pre">Pygphoto</span></code>
must forward every signals emitted by <code class="docutils literal"><span class="pre">CameraWatcher</span></code> to the
exterior. The same goes for slots connections. As a consequence, every
slot and signal of <code class="docutils literal"><span class="pre">CameraWatcher</span></code> is duplicated in the the parent
<code class="docutils literal"><span class="pre">Pygphoto</span></code> class.</p>
</div>
<div class="section" id="camera-locking">
<h2><a class="toc-backref" href="#id4">3.3.1.3. Camera locking</a><a class="headerlink" href="#camera-locking" title="Permalink to this headline">¶</a></h2>
<p>The camera device can be busy for several reasons. This usually end up
throwing the following error message</p>
<div class="highlight-python"><div class="highlight"><pre>*** Error ***
An error occurred in the io-library (&#39;Could not lock the device&#39;): Camera is already in use.
*** Error (-60: &#39;Could not lock the device&#39;) ***
</pre></div>
</div>
<p>Sometimes it comes from other processes or daemons accessing the
camera. We do not do anything about them and we did not explore this
issue further. Sometimes, however, the lock comes from simultaneous
calls to <code class="docutils literal"><span class="pre">gphoto2</span></code> made by the application. To avoid such problems, we
use a <a class="reference external" href="http://docs.python.org/3.4/library/threading.html#threading.Lock">thread synchronization lock</a>
every time we make a call to <code class="docutils literal"><span class="pre">gphoto2</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="bp">self</span><span class="o">.</span><span class="n">_camera_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
<span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">Pygphoto</span><span class="o">.</span><span class="n">_GPHOTO</span><span class="p">,</span> <span class="s">&quot;--auto-detect&quot;</span><span class="p">]</span>
<span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_camera_lock</span><span class="p">:</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">command</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="c"># The call has returned, the lock is released</span>
<span class="c"># Continue working with output...</span>
</pre></div>
</div>
<p>The lock is internal to the <code class="docutils literal"><span class="pre">Pygphoto</span></code> class, the only class that can
make calls to <code class="docutils literal"><span class="pre">gphoto2</span></code>. The lock issue is thus hidden from the
exterior. It is important to note that the <code class="docutils literal"><span class="pre">Pygphoto</span></code> class should not
be instantiated twice, and could actually be implemented as a
singleton class.</p>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="picture_manager.html" class="btn btn-neutral float-right" title="3.3.2. Picture Manager">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../components_detail.html" class="btn btn-neutral" title="3.3. Components implementation"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Matthias Benkort, Nicolas Gaborit, Arthur Manoha, Matthieu Pizenberg, Louis Viot.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>